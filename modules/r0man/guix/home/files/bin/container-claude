#!/usr/bin/env bash
# Run Claude Code inside a Guix container with proper isolation

set -euo pipefail

# Default Claude arguments (can be overridden by setting CLAUDE_ARGS)
CLAUDE_ARGS="${CLAUDE_ARGS:---dangerously-skip-permissions}"

# Shell arguments for guix shell (can be overridden by pre-setting SHELL_ARGS)
if [ -z "${SHELL_ARGS+x}" ]; then
    SHELL_ARGS=()
fi

# SSH agent socket (if available)
if [ -n "${SSH_AUTH_SOCK:-}" ] && [ -S "$SSH_AUTH_SOCK" ]; then
    SHELL_ARGS+=(--expose="$SSH_AUTH_SOCK")
fi

# GPG agent sockets directory (if available)
GPG_SOCKET_DIR=$(gpgconf --list-dirs socketdir 2>/dev/null || true)
if [ -n "$GPG_SOCKET_DIR" ] && [ -d "$GPG_SOCKET_DIR" ]; then
    SHELL_ARGS+=(--expose="$GPG_SOCKET_DIR")
fi

# GPG home directory (needs write access for lock files)
if [ -d "${GNUPGHOME:-$HOME/.gnupg}" ]; then
    SHELL_ARGS+=(--share="${GNUPGHOME:-$HOME/.gnupg}")
fi

# X11 authority file (if available)
if [ -n "${XAUTHORITY:-}" ] && [ -f "$XAUTHORITY" ]; then
    SHELL_ARGS+=(--expose="$XAUTHORITY")
fi

# Ensure required directories exist
mkdir -p "$HOME/.claude"

# Execute guix shell with container
exec guix shell \
     --container \
     --emulate-fhs \
     --expose=/gnu/store \
     --expose=/var/guix/daemon-socket \
     --link-profile \
     --nesting \
     --network \
     --preserve='^ANTHROPIC_API_KEY$' \
     --preserve='^COLORTERM$' \
     --preserve='^DISPLAY$' \
     --preserve='^GNUPGHOME$' \
     --preserve='^GPG_AGENT_INFO$' \
     --preserve='^HOME$' \
     --preserve='^LANG$' \
     --preserve='^LC_.*$' \
     --preserve='^PATH$' \
     --preserve='^SSH_AUTH_SOCK$' \
     --preserve='^TERM$' \
     --preserve='^USER$' \
     --preserve='^XAUTHORITY$' \
     --preserve='^XDG_CONFIG_HOME$' \
     --preserve='^XDG_DATA_HOME$' \
     --preserve='^XDG_RUNTIME_DIR$' \
     --share="$HOME/.claude" \
     --share="$HOME/.claude.json" \
     --share="$HOME/.config/git" \
     --share="$HOME/.emacs.d" \
     --share="$HOME/.gitconfig" \
     --share="$HOME/.ssh/known_hosts" \
     "${SHELL_ARGS[@]}" \
     bash \
     beads \
     coreutils \
     curl \
     diffutils \
     emacs \
     findutils \
     gawk \
     git \
     gnupg \
     grep \
     inetutils \
     jq \
     ncurses \
     node-anthropic-ai-claude-code \
     nss-certs \
     openssh \
     procps \
     python \
     ripgrep \
     sed \
     tar \
     tree \
     wget \
     which \
     -- claude $CLAUDE_ARGS "$@"
