#!/usr/bin/env bash
# Run Claude Code inside a Guix container with proper isolation

set -euo pipefail

# Build expose/share arguments for optional paths
EXTRA_ARGS=()

# SSH agent socket (if available)
if [ -n "${SSH_AUTH_SOCK:-}" ] && [ -S "$SSH_AUTH_SOCK" ]; then
    EXTRA_ARGS+=(--expose="$SSH_AUTH_SOCK")
fi

# GPG agent sockets directory (if available)
GPG_SOCKET_DIR=$(gpgconf --list-dirs socketdir 2>/dev/null || true)
if [ -n "$GPG_SOCKET_DIR" ] && [ -d "$GPG_SOCKET_DIR" ]; then
    EXTRA_ARGS+=(--expose="$GPG_SOCKET_DIR")
fi

# GPG home directory (needs write access for lock files)
if [ -d "${GNUPGHOME:-$HOME/.gnupg}" ]; then
    EXTRA_ARGS+=(--share="${GNUPGHOME:-$HOME/.gnupg}")
fi

# X11 authority file (if available)
if [ -n "${XAUTHORITY:-}" ] && [ -f "$XAUTHORITY" ]; then
    EXTRA_ARGS+=(--expose="$XAUTHORITY")
fi

# Ensure required directories exist
mkdir -p "$HOME/.claude"

# Execute guix shell with container
exec guix shell \
     --container \
     --emulate-fhs \
     --expose=/gnu/store \
     --link-profile \
     --nesting \
     --network \
     --preserve='^ANTHROPIC_API_KEY$' \
     --preserve='^COLORTERM$' \
     --preserve='^DISPLAY$' \
     --preserve='^GNUPGHOME$' \
     --preserve='^GPG_AGENT_INFO$' \
     --preserve='^HOME$' \
     --preserve='^LANG$' \
     --preserve='^LC_.*$' \
     --preserve='^PATH$' \
     --preserve='^SSH_AUTH_SOCK$' \
     --preserve='^TERM$' \
     --preserve='^USER$' \
     --preserve='^XAUTHORITY$' \
     --preserve='^XDG_CONFIG_HOME$' \
     --preserve='^XDG_DATA_HOME$' \
     --preserve='^XDG_RUNTIME_DIR$' \
     --share="$HOME/.claude" \
     --share="$HOME/.claude.json" \
     --share="$HOME/.config/git" \
     --share="$HOME/.emacs.d" \
     --share="$HOME/.gitconfig" \
     "${EXTRA_ARGS[@]}" \
     bash \
     beads \
     coreutils \
     curl \
     diffutils \
     emacs \
     findutils \
     gawk \
     git \
     gnupg \
     grep \
     inetutils \
     ncurses \
     node-anthropic-ai-claude-code \
     nss-certs \
     openssh \
     procps \
     ripgrep \
     sed \
     tree \
     which \
     -- claude "$@"
