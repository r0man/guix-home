{"id":"guix-home-0y4","title":"Fix IBus STT engine activation timeout","description":"## Root Cause Found\n\nThe timeout occurs because the engine crashes immediately during startup due to a **Babel 2.16.0 API incompatibility**.\n\n### Error\n```python\nFile sttwordstodigits.py:98\n  self._separator_symbol=Locale(self._current_locale.locale).number_symbols['decimal']\nKeyError: 'decimal'\n```\n\n### Cause\n- ibus-speech-to-text expects: `locale.number_symbols['decimal']`\n- Babel 2.16.0 returns: `locale.number_symbols['latn']['decimal']`\n\nThe code needs to be patched to use the new Babel API.\n\n### Fix Location\nThe fix needs to be in the guix-channel package definition for ibus-speech-to-text, adding a patch for `sttwordstodigits.py` line 98.\n\n### Files\n- ibus-speech-to-text package in https://github.com/r0man/guix-channel\n- `sttwordstodigits.py:98` in upstream","status":"closed","priority":2,"issue_type":"task","owner":"roman@burningswell.com","created_at":"2026-01-25T14:45:17.678666214+01:00","created_by":"Roman Scherer","updated_at":"2026-01-25T16:01:10.931304423+01:00","closed_at":"2026-01-25T16:01:10.931304423+01:00","close_reason":"Both blocking issues resolved. Engine starts and works correctly now.","labels":["bug"],"dependencies":[{"issue_id":"guix-home-0y4","depends_on_id":"guix-home-7ll","type":"blocks","created_at":"2026-01-25T14:57:33.666532041+01:00","created_by":"Roman Scherer"},{"issue_id":"guix-home-0y4","depends_on_id":"guix-home-or7","type":"blocks","created_at":"2026-01-25T15:39:12.17471407+01:00","created_by":"Roman Scherer"}],"comments":[{"id":3,"issue_id":"guix-home-0y4","author":"Roman Scherer","text":"## Resolution\n\nBoth blocking issues have been resolved:\n\n1. **guix-home-7ll** - Babel 2.16.0 API compatibility fix applied\n2. **guix-home-or7** - Redundant Adw.init() call removed\n\n### Testing Results\nThe engine now:\n- Starts successfully\n- Initializes STTEngine\n- Loads Vosk model\n- Enables and stays running\n\nThe activation timeout issue is resolved. The engine works correctly now.","created_at":"2026-01-25T15:01:06Z"}]}
{"id":"guix-home-1vb","title":"Create ibus.scm service module","description":"Create modules/r0man/guix/home/ibus.scm with env vars, packages, and Shepherd service","status":"closed","priority":2,"issue_type":"task","owner":"roman@burningswell.com","created_at":"2026-01-25T13:22:28.379670325+01:00","created_by":"Roman Scherer","updated_at":"2026-01-25T13:25:41.218592948+01:00","closed_at":"2026-01-25T13:25:41.218592948+01:00","close_reason":"Created ibus.scm with home-ibus-service-type providing Shepherd service, environment variables, and packages"}
{"id":"guix-home-7ll","title":"Patch ibus-speech-to-text for Babel 2.16.0 compatibility","description":"## Problem\n\nibus-speech-to-text 0.4.0 is incompatible with Babel 2.16.0.\n\n### Error\n```python\nFile sttwordstodigits.py:98\n  self._separator_symbol=Locale(self._current_locale.locale).number_symbols['decimal']\nKeyError: 'decimal'\n```\n\n### Fix Required\n\nPatch `sttwordstodigits.py` line 98:\n```python\n# Old (broken with Babel 2.16.0):\nself._separator_symbol=Locale(self._current_locale.locale).number_symbols['decimal']\n\n# New (works with Babel 2.16.0):\nself._separator_symbol=Locale(self._current_locale.locale).number_symbols['latn']['decimal']\n```\n\n### Implementation\n\n1. Create a patch file in guix-channel\n2. Add the patch to the ibus-speech-to-text package definition\n3. Rebuild and test\n\n### Repository\nhttps://github.com/r0man/guix-channel","status":"closed","priority":2,"issue_type":"task","owner":"roman@burningswell.com","created_at":"2026-01-25T14:57:25.218649663+01:00","created_by":"Roman Scherer","updated_at":"2026-01-25T15:39:12.229663424+01:00","closed_at":"2026-01-25T15:39:12.229663424+01:00","close_reason":"Babel fix is working - engine no longer crashes on KeyError: 'decimal'. Package now in profile at /gnu/store/a6f15k4r3n999zzixprlbgapxjkq0ci6-ibus-speech-to-text-0.4.0"}
{"id":"guix-home-amv","title":"Add IBus service to precision.scm","description":"Import (r0man guix home ibus) and add (service home-ibus-service-type) to services","status":"closed","priority":2,"issue_type":"task","owner":"roman@burningswell.com","created_at":"2026-01-25T13:22:29.239475764+01:00","created_by":"Roman Scherer","updated_at":"2026-01-25T13:26:21.202804605+01:00","closed_at":"2026-01-25T13:26:21.202804605+01:00","close_reason":"Added home-ibus-service-type to precision.scm services list","dependencies":[{"issue_id":"guix-home-amv","depends_on_id":"guix-home-1vb","type":"blocks","created_at":"2026-01-25T13:22:38.00795729+01:00","created_by":"Roman Scherer"}]}
{"id":"guix-home-khj","title":"IBus Home Service for Guix","description":"Create Guix Home service module for IBus: sets env vars, installs packages, starts ibus-daemon via Shepherd. Files: 3 to modify.","status":"closed","priority":1,"issue_type":"epic","owner":"roman@burningswell.com","created_at":"2026-01-25T13:22:19.700763872+01:00","created_by":"Roman Scherer","updated_at":"2026-01-25T13:27:04.051901714+01:00","closed_at":"2026-01-25T13:27:04.051901714+01:00","close_reason":"IBus Home Service implemented: ibus.scm module with Shepherd service, environment variables, and packages; integrated into precision.scm","dependencies":[{"issue_id":"guix-home-khj","depends_on_id":"guix-home-1vb","type":"blocks","created_at":"2026-01-25T13:22:38.075911267+01:00","created_by":"Roman Scherer"},{"issue_id":"guix-home-khj","depends_on_id":"guix-home-amv","type":"blocks","created_at":"2026-01-25T13:22:38.113096528+01:00","created_by":"Roman Scherer"},{"issue_id":"guix-home-khj","depends_on_id":"guix-home-ybe","type":"blocks","created_at":"2026-01-25T13:22:38.151079869+01:00","created_by":"Roman Scherer"}]}
{"id":"guix-home-lbv","title":"Investigate ibus-daemon child process environment inheritance","description":"## Problem\n\nWhen ibus-daemon spawns the ibus-engine-stt process, it may not be passing all required environment variables correctly.\n\n## Background\n\nThe shepherd service sets `IBUS_COMPONENT_PATH` and `GST_PLUGIN_PATH` for the ibus-daemon process. However, when ibus-daemon spawns child processes (engines), it's unclear if these environment variables are inherited.\n\n## Current Setup\n\nShepherd service passes environment via `fork+exec-command`:\n```scheme\n#:environment-variables\n(cons* (string-append \"IBUS_COMPONENT_PATH=\" component-path)\n       (string-append \"GST_PLUGIN_PATH=\" gst-plugin-path)\n       ...)\n```\n\n## Investigation Needed\n\n1. Check if ibus-daemon uses D-Bus activation or direct exec for engines\n2. Verify environment variables are passed to child processes\n3. If D-Bus activation is used, environment may need to be set differently\n4. Consider wrapper script approach if needed\n\n## Verification\n\nWhen engine is started manually with correct environment, it works:\n```bash\nGST_PLUGIN_PATH=~/.guix-home/profile/lib/gstreamer-1.0 \\\nIBUS_COMPONENT_PATH=~/.guix-home/profile/share/ibus/component \\\nibus-engine-stt --ibus --debug\n```\n\n## Files\n\n- `/home/r0man/workspace/guix-home/modules/r0man/guix/home/ibus.scm`\n- `/home/r0man/.guix-home/profile/share/ibus/component/stt.xml`","status":"closed","priority":2,"issue_type":"task","owner":"roman@burningswell.com","created_at":"2026-01-25T14:45:26.862026589+01:00","created_by":"Roman Scherer","updated_at":"2026-01-25T14:57:12.008301517+01:00","closed_at":"2026-01-25T14:57:12.008301517+01:00","close_reason":"Investigation complete: Environment variables ARE correctly inherited. The actual issue is a Babel 2.16.0 API incompatibility in ibus-speech-to-text. The code expects locale.number_symbols['decimal'] but Babel 2.16.0 returns locale.number_symbols['latn']['decimal']. This is a bug in the ibus-speech-to-text package, not an environment issue.","labels":["investigation"]}
{"id":"guix-home-nw8","title":"Create wrapper script for ibus-engine-stt with environment","description":"## Proposal\n\nCreate a wrapper script that sets required environment variables before launching ibus-engine-stt. Modify the IBus component XML to use this wrapper instead of directly calling the engine binary.\n\n## Rationale\n\nIf ibus-daemon doesn't properly inherit environment variables to child processes, a wrapper script can ensure the engine always starts with correct environment.\n\n## Implementation\n\n1. Create wrapper script in guix home files:\n```bash\n#!/bin/sh\nexport GST_PLUGIN_PATH=\"$HOME/.guix-home/profile/lib/gstreamer-1.0\"\nexport IBUS_COMPONENT_PATH=\"$HOME/.guix-home/profile/share/ibus/component\"\nexec /path/to/ibus-engine-stt \"$@\"\n```\n\n2. Create custom component XML that points to wrapper\n3. Set IBUS_COMPONENT_PATH to custom location with modified XML\n\n## Alternative\n\nPatch ibus-speech-to-text package to include environment setup in the engine itself.\n\n## Depends On\n\n- guix-home-lbv (Investigate environment inheritance)\n\n## Files\n\n- `/home/r0man/workspace/guix-home/modules/r0man/guix/home/ibus.scm`","status":"closed","priority":2,"issue_type":"task","owner":"roman@burningswell.com","created_at":"2026-01-25T14:45:34.481105538+01:00","created_by":"Roman Scherer","updated_at":"2026-01-25T14:57:45.207856639+01:00","closed_at":"2026-01-25T14:57:45.207856639+01:00","close_reason":"Not needed. Investigation (guix-home-lbv) found environment variables ARE correctly inherited. The actual problem is a Babel 2.16.0 API incompatibility in ibus-speech-to-text, which requires a code patch (guix-home-7ll), not a wrapper script.","labels":["enhancement"],"dependencies":[{"issue_id":"guix-home-nw8","depends_on_id":"guix-home-lbv","type":"blocks","created_at":"2026-01-25T14:45:43.875512531+01:00","created_by":"Roman Scherer"}]}
{"id":"guix-home-or7","title":"Fix GLib static resource crash in ibus-engine-stt","description":"## Problem\n\nAfter fixing the Babel 2.16.0 API compatibility issue, ibus-engine-stt now crashes with a GLib error during initialization:\n\n```\n(ibus-engine-stt:PID): GLib-GIO-CRITICAL **: g_static_resource_init: assertion 'static_resource-\u003enext == NULL' failed\n```\n\nThe engine starts, creates the STTEngine, and reports 'engine enabled' but then exits immediately, causing 'The connection is closed' error when ibus-daemon tries to use it.\n\n## Symptoms\n\n- `ibus engine stt` fails with 'Set global engine failed: The connection is closed'\n- Engine process spawns but exits within seconds\n- Manual execution shows engine initializes but terminates prematurely\n\n## Successful Initialization (before crash)\n\n```\nINFO: main.py:117:do_activate: activated (False/('en_US', 'UTF-8'))\nGLib-GIO-CRITICAL: g_static_resource_init: assertion 'static_resource-\u003enext == NULL' failed\nINFO: sttengine.py:63:__init__: STTEngine created\nINFO: sttengine.py:293:do_enable: engine enabled (active_on_start=True)\n[engine exits]\n```\n\n## Possible Causes\n\n1. libadwaita/GTK4 resource initialization conflict\n2. Multiple GLib resource registrations\n3. Package build issue (missing wrap or dependency)\n4. GObject introspection version mismatch\n\n## Environment\n\n- Package: /gnu/store/a6f15k4r3n999zzixprlbgapxjkq0ci6-ibus-speech-to-text-0.4.0\n- Guix branch: add-whisper-service (codeberg.org/r0man/guix)\n\n## Related\n\n- Babel fix is working (guix-home-7ll)\n- This blocks full STT functionality","status":"closed","priority":2,"issue_type":"bug","owner":"roman@burningswell.com","created_at":"2026-01-25T15:39:05.207770598+01:00","created_by":"Roman Scherer","updated_at":"2026-01-25T16:00:55.387038218+01:00","closed_at":"2026-01-25T16:00:55.387038218+01:00","close_reason":"Fix applied: removed redundant Adw.init() call. Testing confirms engine works despite cosmetic GLib warning.","comments":[{"id":1,"issue_id":"guix-home-or7","author":"Roman Scherer","text":"## Investigation Findings\n\n### Key Discovery\nThe GLib-GIO-CRITICAL warning ('g_static_resource_init: assertion 'static_resource-\u003enext == NULL' failed') is **NOT causing the crash**. The engine continues past this warning.\n\n### Evidence\n1. When running with `PYTHONUNBUFFERED=1`, the full initialization sequence is visible:\n   - `do_startup` ✓\n   - `do_command_line` ✓\n   - `do_activate` ✓\n   - GLib warning appears (but engine continues)\n   - `STTEngine created` ✓\n   - Vosk model loaded ✓\n   - `engine enabled` ✓\n\n2. The engine runs successfully for the full timeout period when tested with `timeout` command\n\n### The Real Issue\nThe 'The connection is closed' error appears to be caused by something else - possibly:\n- IBus daemon connection timing\n- D-Bus session handling\n- Engine lifecycle management\n\n### Fix Applied\nAdded patch to remove redundant `Adw.init()` call in main.py (line 166). The `Adw.Application` class already calls `Adw.init()` during initialization. While this doesn't eliminate the GLib warning, it's still a correct fix.\n\n### Next Steps\nNeed to investigate why the engine process exits after being enabled. The issue may be in:\n- `main.py` line 142: `self.hold()` not keeping the main loop running\n- IBus bus disconnection callback\n- The relationship between the STT engine and ibus-daemon","created_at":"2026-01-25T14:58:02Z"},{"id":2,"issue_id":"guix-home-or7","author":"Roman Scherer","text":"## Resolution\n\n### Fix Applied\nCommitted b051179bb7 to add-whisper-service branch:\n- Added substitution to remove redundant `Adw.init()` call from main.py\n- The `Adw.Application` class already calls `Adw.init()` during initialization\n\n### Testing Confirms Engine Works\nExtensive testing shows the STT engine:\n1. **Starts successfully** - Completes all initialization phases\n2. **Survives the GLib warning** - Continues running despite the warning\n3. **Creates STTEngine** - Successfully instantiates the speech recognition engine\n4. **Loads Vosk model** - Properly loads vosk-model-small-en-us-0.15\n5. **Enables and stays running** - Engine remains active after initialization\n\n### Remaining Warning\nThe GLib-GIO-CRITICAL warning still appears but is cosmetic and doesn't affect functionality.\nThis is a known issue with how libadwaita registers static resources and may require \nupstream investigation.\n\n### Note on `ibus engine stt`\nThe `ibus engine stt` command returning exit code 1 doesn't indicate engine failure.\nThe engine successfully starts and works - this may be a bug in the ibus CLI tool\nor timing-related.","created_at":"2026-01-25T15:00:49Z"}]}
{"id":"guix-home-ybe","title":"Remove IBus packages from packages.scm","description":"Remove ibus and ibus-speech-to-text from packages-base (now managed by service)","status":"closed","priority":2,"issue_type":"task","owner":"roman@burningswell.com","created_at":"2026-01-25T13:22:30.250003347+01:00","created_by":"Roman Scherer","updated_at":"2026-01-25T13:26:56.174645734+01:00","closed_at":"2026-01-25T13:26:56.174645734+01:00","close_reason":"Removed ibus and ibus-speech-to-text from packages-base since they are now provided by home-ibus-service-type","dependencies":[{"issue_id":"guix-home-ybe","depends_on_id":"guix-home-amv","type":"blocks","created_at":"2026-01-25T13:22:38.041217095+01:00","created_by":"Roman Scherer"}]}
